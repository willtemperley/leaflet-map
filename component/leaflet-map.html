<link rel="import" href="../polymer/polymer-element.html">
<script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
        integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
        crossorigin=""></script>

<link rel="import" href="leaflet-marker-simple.html">

<dom-module id="leaflet-map">
  <template>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
          integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
          crossorigin=""/>
    <style>
      :host {
        display: block;
      }
      :host #map {
        height:100%;
        width:100%
      }

    </style>
    <div id="map">

    </div>
    <slot></slot>
  </template>

  <script>
    /**
     * `leaflet-map`
     * lmap
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class LeafletMap extends Polymer.Element {
      static get is() { return 'leaflet-map'; }
      static get properties() {
        return {

          /**
           * The `latitude` attribute sets the map center.
           *
           * @attribute latitude
           * @type number
           */
          latitude: {
            type: Number,
            readOnly: false,
            value: 51,
            reflectToAttribute: true,
            notify: true,
            observer: '_viewChanged'
          },

          /**
           * The `longitude` attribute sets the map center.
           *
           * @attribute longitude
           * @type number
           */
          longitude: {
            type: Number,
            value: 0,
            reflectToAttribute: true,
            notify: true,
            observer: '_viewChanged'
          },

          /**
           * The `zoom` attribute sets the map zoom.
           *
           * @attribute zoom
           * @type number
           */
          zoom: {
            type: Number,
            value: -1,
            reflectToAttribute: true,
            notify: true,
            observer: '_viewChanged'
          }

        };
      }

      _registerMapOnChildren() {

        for (let i = 0; i < this.children.length; i++) {
          console.log(this.children[i].attributes.latitude);

          // let marker = this.children[i];
          // marker._setProperty("latitude", 222);
          let m = this.children[i];

          // m.set('container', this.map);
          m.container = this.map;
        }

        // this._fitToMarkers();
      }

      connectedCallback() {
        super.connectedCallback();

        this.map = L.map(this.$.map);

        L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery Â© <a href="http://mapbox.com">Mapbox</a>',
          maxZoom: 18
        }).addTo(this.map);


        this._viewChanged(null, null);

        // create custom icon
        // let firefoxIcon = L.icon({
        //   iconUrl: 'http://joshuafrazier.info/images/firefox.svg',
        //   iconSize: [38, 95], // size of the icon
        // });
        // L.marker([this.latitude, this.longitude], {icon: firefoxIcon}).addTo(this.map);

        this._registerMapOnChildren();

      }

      _fitToMarkers() {
        if ( this.map ) {
          let bounds = [];
          for( let i = 0, f; f = this.children[i]; i++ ) {
            if ( f.latitude && f.longitude ) {
              bounds.push( [ f.latitude, f.longitude ] );
            }
          }
          if ( bounds.length > 0 ) {
            this.map.fitBounds( bounds );
            this.map.invalidateSize();
          }
        }
      }

      _viewChanged(newValue, oldValue) {

        if (this.map) {
          console.log("_viewChanged");
          this.map.setView(L.latLng(this.latitude, this.longitude), this.zoom);
        }
      }

    }

    window.customElements.define(LeafletMap.is, LeafletMap);
  </script>
</dom-module>
